## VMC + MediaPipe + OpenVR トラッキングシステム マニュアル

このマニュアルでは、上記の Python スクリプトを使用して、MediaPipe によるフルトラッキング (顔、体、手) のデータを VMC プロトコル経由で送信し、OpenVR を通じて VR 空間内のトラッカーとして反映させるシステムの使用方法を説明します。

### 1. 必要なもの

*   **VR ヘッドセット:** Valve Index, HTC Vive, Oculus Rift (SteamVR 対応のもの) など。
*   **SteamVR:** インストールされ、動作していること。
*   **Python:** 3.7 以降 (3.9 推奨)。
*   **必要なライブラリ:** `opencv-python`, `mediapipe`, `pyopenvr`, `python-osc`, `numpy`
*   **VMC プロトコル受信ソフト:** VSeeFace など。
*   **Webカメラ:** PC に接続されていること。
*   **(オプション) VR トラッカー:** より高度なフルトラッキングを行う場合 (腰や足など)。無くても動作します。

### 2. セットアップ

1.  **ライブラリのインストール:**
    ターミナル (Windows の場合はコマンドプロンプトや PowerShell) を開き、以下のコマンドを実行します。

    ```bash
    pip install opencv-python mediapipe pyopenvr python-osc numpy
    ```

2.  **Python スクリプトの準備:**
    上記の Python コードを `vmc_tracking.py` などの名前で保存します。

3.  **VMC 受信ソフトの設定:**
    *   VSeeFace などの VMC プロトコルを受信できるソフトウェアを起動します。
    *   受信設定で、IP アドレス `127.0.0.1` (localhost)、ポート `39539` を指定します。
    *   VSeeFace の場合、通常は自動で `127.0.0.1:39539` で VMC Protocol を待ち受けています。設定が異なる場合は、VSeeFace の設定を確認してください。

4. **SteamVRの設定**
    * SteamVRを起動します。
    * VR空間内で、SteamVRダッシュボードを開き、このスクリプトによって生成されたトラッカーが認識されているかを確認します。

### 3. 実行

1.  **VR ヘッドセットの装着:**  VR ヘッドセットを装着し、SteamVR が正常に動作していることを確認します。
2.  **Python スクリプトの実行:**
    ターミナルで、`vmc_tracking.py` を保存したディレクトリに移動し、以下のコマンドを実行します。

    ```bash
    python vmc_tracking.py
    ```

3.  **トラッカーの確認:**
    *   スクリプトを実行すると、`VMC Tracking` というウィンドウが表示され、Web カメラの映像が表示されます。
    *   SteamVR 内で、"VMC_Head_Tracker" という名前のトラッカーが追加され、頭の動きに追従することを確認します。
    *   VSeeFace などの VMC 受信ソフトで、アバターが頭、表情、手、体の動きに追従することを確認します。

### 4. トラブルシューティング

*   **アバターが動かない:**
    *   VMC 受信ソフトの設定 (IP アドレス、ポート) が正しいか確認してください。
    *   Python スクリプトがエラーなく実行されているか確認してください。
    *   SteamVR が正常に動作しているか確認してください。
    *   VRヘッドセットやコントローラ、ベースステーションが正しく接続され、トラッキングされているかを確認してください。
*   **トラッカーが SteamVR に表示されない:**
    *   SteamVR を再起動してみてください。
    *   Python スクリプトの `openvr.init()` がエラーを返していないか確認してください。
*   **トラッキングがずれる/不安定:**
    *   Web カメラが十分な明るさの場所にあるか確認してください。
    *   顔や手がカメラにしっかりと映っているか確認してください。
    *   背景が複雑でないか確認してください (無地の壁などが理想的)。
    *   MediaPipe の `min_detection_confidence` や `min_tracking_confidence` の値を調整してみてください (値を大きくすると、より確実な検出/追跡が行われますが、誤検出が減る代わりに追跡が途切れやすくなる可能性があります)。
    * スクリプト内の`update_openvr_trackers`関数で、座標変換が正しく行われているか確認してください。
* **特定のエラーメッセージが表示される:**
    * エラーメッセージの内容をよく読み、原因を特定してください。
    * 多くの場合は、必要なライブラリがインストールされていない、バージョンが古い、OpenVR/SteamVR の初期化に失敗している、などが原因です。

### 5. スクリプトのカスタマイズ (上級者向け)

*   **OpenVR での手や体のトラッキングの追加:**
    `update_openvr_trackers` 関数を拡張し、`tracking_data["hands"]` や `tracking_data["pose"]` の情報を使って、手のトラッカー ("VMC_LeftHand_Tracker", "VMC_RightHand_Tracker") や体のトラッカー ("VMC_Hips_Tracker" など) を追加できます。
*   **キャリブレーションの実装:**
    ユーザーに特定のポーズを取らせるなどして、MediaPipe と OpenVR の座標系を一致させるキャリブレーション処理を追加できます。
*   **スムージングの適用:**
     MediaPipe からのトラッキングデータにスムージングフィルター (例: カルマンフィルター) を適用して、ジッターを軽減できます。
*   **ボーンローテーションの改善**:
    `process_pose_landmarks`関数内で、プレースホルダーとなっている`rotation`の値を、各ボーンの向きに基づいて計算するように変更します。

### 6. 使用上の注意

*   このスクリプトは、VMC Protocol の送信と OpenVR でのトラッカー更新のみを行います。アバターの制御や表示は、VMC 受信ソフト (VSeeFace など) 側で行う必要があります。
*   MediaPipe のトラッキング精度は、カメラの性能、照明条件、背景などに大きく影響されます。
*   OpenVR のトラッカーは、SteamVR の設定で有効/無効を切り替えたり、位置や回転を調整したりできます。

このマニュアルとスクリプトが、VMC を活用した VR トラッキングの構築に役立つことを願っています。
